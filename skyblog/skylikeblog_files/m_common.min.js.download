function connect_deep(mid,token,cnt){var notiOpen=true;var num_error=1;if(notiOpen&&token.length>0&&(detectIE()===false||detectIE()>=10)){client=deepstream('wss://'+window.location.host+'/deep/deepstream').login({token:token,},function(success,data){if(success&&data.status){client.event.subscribe(''+data.mid+'',function(json){var json=$.extend({},json,data);show_noti(json);});}});client.on('connectionStateChanged',function(connectionState){if(connectionState=='RECONNECTING'){}
if(connectionState=='OPEN'){}
if(connectionState=='ERROR'&&num_error==3){}});}}
function tpl_noti_detail(json){var max_str=60;var topic=json.disp_topic;if(json.disp_topic.length>=max_str){topic=json.disp_topic.substr(0,max_str)+"...";}
var html='<div id="'+json.rand+'" class="relative realtime-list-msg">'
+'<a title="ปิด" class="noti-realtime-close-msg"></a>'
+'<div class="realtime-list"><a href="'+json.last_url+'" target="_blank" style="color:#000">'
+'<div class="noti-realtime-avatar">'
+'<img src="'+json.avatar+'" width="32px;" height="32px;">'
+'<div class="relative">'
+'<span class="icon-noti-comment-msg inactive"></span>'
+'<div class="noti-realtime-action">'+json.answer+'  ตอบกระทู้ '
+'<br/>'+topic
+'</div>'
+'</div>'
+'</div>'
+'</a></div>'
+'</div>';return html;}
function show_noti(json){if(json.noti_cnt>0){if(json.noti_cnt>999){json.noti_cnt='999+';}
$('.total-noti').html('<b class="pt-nav__badge">'+json.noti_cnt+'</b>');}else{$('.total-noti').html('');}
if(typeof json.close_noti!=='undefined'&&json.close_noti==false&&typeof json.noti_detail!=='undefined'&&json.noti_detail!=''){if($('.noti-realtime').find('.realtime-list-msg#'+json.noti_detail.rand).length==0){var oDialog=$(tpl_noti_detail(json.noti_detail));var oDialogLength=$('.noti-realtime').find('.realtime-list-msg').length;if(oDialogLength>2){$('.noti-realtime').find('.realtime-list-msg:eq('+(oDialogLength-1)+')').remove();}
$('.noti-realtime').prepend(oDialog);hideDialod(oDialog);}}}
function hideDialod(oDialog){var timeoutId=setTimeout(function(){oDialog.fadeOut(5000,function(){oDialog.remove();});$('div.noti-mouse-hover').fadeOut(2000,function(){$(this).remove();if(typeof $('.noti-realtime').data('timeoutId')!=="undefined"){clearTimeout($('.noti-realtime').data('timeoutId'));}});},15000);oDialog.data('timeoutId',timeoutId);$('div.realtime-list-msg').off().on('mouseover mouseenter',function(){if(typeof $('.noti-realtime').data('timeoutId')!=="undefined"){clearTimeout($('.noti-realtime').data('timeoutId'));}
if(typeof timeoutId!=="undefined"){clearTimeout(timeoutId);}
$('div.realtime-list-msg:not(.noti-mouse-hover)').addClass('noti-mouse-hover');$('div.realtime-list-msg').stop().animate({opacity:'100'}).fadeIn(500);}).on('mouseleave',function(){var someElement=$('.noti-realtime'),timeoutId=setTimeout(function(){$('div.noti-mouse-hover').fadeOut(2000,function(){$('div.noti-mouse-hover').remove();});},5000);someElement.data('timeoutId',timeoutId);});}
function detectIE()
{var ua=window.navigator.userAgent;var msie=ua.indexOf('MSIE ');if(msie>0){return parseInt(ua.substring(msie+5,ua.indexOf('.',msie)),10);}
var trident=ua.indexOf('Trident/');if(trident>0){var rv=ua.indexOf('rv:');return parseInt(ua.substring(rv+3,ua.indexOf('.',rv)),10);}
var edge=ua.indexOf('Edge/');if(edge>0){return parseInt(ua.substring(edge+5,ua.indexOf('.',edge)),10);}
return false;}
$(document).ready(function(){var url="/notification/is_login_node?time="+Math.random();$.ajax({url:url,dataType:'json',success:function(result){if(result!=undefined&&result.mid!=undefined){show_noti({"noti_cnt":result.cnt});connect_deep(result.mid,result.token,result.cnt);}
else{connect_deep(0,0,0);}}});$(document).on('click','.noti-realtime-close-msg',function(){$(this).parent().remove();});});